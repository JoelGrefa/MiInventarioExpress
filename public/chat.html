<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat en Tiempo Real</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="nav">
    <div class="brand">MiInventarioExpress</div>
    <div class="nav-spacer"></div>
    <a href="/dashboard">Panel</a>
    <span id="userpill" class="userpill">Cargando…</span>
    <button class="aslink" id="btnLogout">Cerrar sesión</button>
  </nav>

  <main class="container">
    <header class="header">
      <h1>Chat en Tiempo Real</h1>
      <p>Escribe y mira cómo aparece en todas las pestañas</p>
    </header>

    <section class="chat-controls">
      <input class="input" type="text" id="nombre" placeholder="Tu nombre">
      <input class="input" type="text" id="mensaje" placeholder="Escribe un mensaje">
      <button class="btn" onclick="enviarMensaje()">Enviar</button>
    </section>

    <ul id="mensajes"></ul>
  </main>

  <script>
    // Sesión en UI
    async function loadMe() {
      try {
        const res = await fetch('/auth/me');
        const data = await res.json();
        if (!res.ok) return location.href = '/login.html';
        document.getElementById('userpill').textContent = `${data.nombre} · ${data.role}`;
      } catch { location.href = '/login.html'; }
    }
    loadMe();

    document.getElementById('btnLogout').onclick = async () => {
      await fetch('/auth/logout', { method: 'POST' });
      location.href = '/login.html';
    };

    // Chat
    const socket = io();

    function enviarMensaje() {
      const nombre = document.getElementById('nombre').value;
      const mensaje = document.getElementById('mensaje').value;
      const mensajeCompleto = nombre + ': ' + mensaje;

      if (mensaje.trim() !== "") {
        socket.emit('mensaje', mensajeCompleto);
      }
      document.getElementById('mensaje').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('mensaje').focus();
    }

    function eliminarMensaje(event) {
      const li = event.target.closest('li');
      li?.remove();
    }

    socket.on('mensaje', (data) => {
      const ul = document.getElementById('mensajes');
      const li = document.createElement('li');
      li.innerHTML = `<span>${data}</span>`;
      const btn = document.createElement('button');
      btn.textContent = 'Eliminar';
      btn.className = 'btn btn-danger';
      btn.onclick = eliminarMensaje;
      li.appendChild(btn);
      ul.appendChild(li);
    });

    // Historial (si lo tienes activo)
    window.onload = async () => {
      try {
        const res = await fetch('/historial');
        const mensajes = await res.json();
        const ul = document.getElementById('mensajes');
        mensajes.forEach((m) => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${m.nombre}: ${m.mensaje}</span>`;
          const btn = document.createElement('button');
          btn.textContent = 'Eliminar';
          btn.className = 'btn btn-danger';
          btn.onclick = eliminarMensaje;
          ul.appendChild(li);
          li.appendChild(btn);
        });
      } catch {}
    };
  </script>
</body>
</html>
