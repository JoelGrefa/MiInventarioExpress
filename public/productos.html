<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Productos | MiInventarioExpress</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav class="nav">
    <div class="brand">MiInventarioExpress</div>
    <div class="nav-spacer"></div>
    <a href="/dashboard">Panel</a>
    <a href="/chat">Chat</a>
    <span id="userpill" class="userpill">Cargando…</span>
    <button class="aslink" id="btnLogout">Cerrar sesión</button>
  </nav>

  <main class="container">
    <header class="header">
      <h1>Gestión de Productos</h1>
      <p>Crear, listar, actualizar y eliminar (imagen incluida)</p>
    </header>

    <!-- Formulario Crear / Editar -->
    <section class="form">
      <input class="input" type="text" id="nombre" placeholder="Nombre" required />
      <input class="input" type="number" step="0.01" id="precio" placeholder="Precio" required />
      <input class="input" type="text" id="descripcion" placeholder="Descripción" />
      <input class="input" type="file" id="imagen" accept="image/*" />
      <div class="actions" style="margin-top:8px;">
        <button class="btn" id="btnCrear">Crear</button>
        <button class="btn btn-ghost" id="btnLimpiar" type="button">Limpiar</button>
      </div>
      <p id="msg" class="status"></p>
    </section>

    <!-- Listado -->
    <section style="margin-top:18px;">
      <table class="table" id="tabla">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Descripción</th>
            <th style="width:180px;">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // Sesión UI
    async function loadMe() {
      try {
        const res = await fetch('/auth/me');
        const data = await res.json();
        if (!res.ok) return location.href = '/login.html';
        document.getElementById('userpill').textContent = `${data.nombre} · ${data.role}`;
      } catch { location.href = '/login.html'; }
    }
    loadMe();

    document.getElementById('btnLogout').onclick = async () => {
      await fetch('/auth/logout', { method: 'POST' });
      location.href = '/login.html';
    };

    const tbody = document.getElementById('tbody');
    const msg = document.getElementById('msg');

    async function listar() {
      tbody.innerHTML = '';
      const res = await fetch('/api/productos');
      const productos = await res.json();
      productos.forEach(p => pintarFila(p));
    }

    function pintarFila(p) {
      const tr = document.createElement('tr');
      const imgSrc = p.imagen ? p.imagen.replace(/^\/?uploads/, '/uploads') : '';
      tr.innerHTML = `
        <td>${imgSrc ? `<img src="${imgSrc}" alt="${p.nombre}">` : '-'}</td>
        <td>${p.nombre}</td>
        <td>$${Number(p.precio).toFixed(2)}</td>
        <td>${p.descripcion || ''}</td>
        <td class="actions">
          <button class="btn btn-ghost" data-edit="${p._id}">Editar</button>
          <button class="btn btn-danger" data-del="${p._id}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // Crear
    document.getElementById('btnCrear').onclick = async () => {
      const nombre = document.getElementById('nombre').value.trim();
      const precio = document.getElementById('precio').value;
      const descripcion = document.getElementById('descripcion').value;
      const file = document.getElementById('imagen').files[0];

      if (!nombre || !precio) { show('Faltan campos'); return; }

      const fd = new FormData();
      fd.append('nombre', nombre);
      fd.append('precio', precio);
      fd.append('descripcion', descripcion);
      if (file) fd.append('imagen', file);

      const res = await fetch('/api/productos', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) return show(data.message || 'Error al crear');
      show('Producto creado');
      limpiarForm();
      listar();
    };

    // Editar / Eliminar delegados
    tbody.onclick = async (e) => {
      const editId = e.target.getAttribute('data-edit');
      const delId  = e.target.getAttribute('data-del');

      if (editId) {
        // Trae el producto y llena el form; el botón Crear hará PUT si hay _idEditing
        const res = await fetch(`/api/productos/${editId}`);
        const p = await res.json();
        setEditing(p);
      }

      if (delId) {
        if (!confirm('¿Eliminar producto?')) return;
        const res = await fetch(`/api/productos/${delId}`, { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) return show(data.message || 'Error al eliminar');
        show('Producto eliminado');
        listar();
      }
    };

    let _idEditing = null;
    function setEditing(p) {
      _idEditing = p._id;
      document.getElementById('nombre').value = p.nombre;
      document.getElementById('precio').value = p.precio;
      document.getElementById('descripcion').value = p.descripcion || '';
      // Cambia lógica del botón Crear a Actualizar
      const btn = document.getElementById('btnCrear');
      btn.textContent = 'Actualizar';
      btn.onclick = async () => {
        const fd = new FormData();
        fd.append('nombre', document.getElementById('nombre').value.trim());
        fd.append('precio', document.getElementById('precio').value);
        fd.append('descripcion', document.getElementById('descripcion').value);
        const file = document.getElementById('imagen').files[0];
        if (file) fd.append('imagen', file);

        const res = await fetch(`/api/productos/${_idEditing}`, { method: 'PUT', body: fd });
        const data = await res.json();
        if (!res.ok) return show(data.message || 'Error al actualizar');
        show('Producto actualizado');
        _idEditing = null;
        resetCrear();
        limpiarForm();
        listar();
      };
    }

    function resetCrear() {
      const btn = document.getElementById('btnCrear');
      btn.textContent = 'Crear';
      btn.onclick = async () => {
        const nombre = document.getElementById('nombre').value.trim();
        const precio = document.getElementById('precio').value;
        const descripcion = document.getElementById('descripcion').value;
        const file = document.getElementById('imagen').files[0];
        if (!nombre || !precio) { show('Faltan campos'); return; }
        const fd = new FormData();
        fd.append('nombre', nombre);
        fd.append('precio', precio);
        fd.append('descripcion', descripcion);
        if (file) fd.append('imagen', file);
        const res = await fetch('/api/productos', { method: 'POST', body: fd });
        const data = await res.json();
        if (!res.ok) return show(data.message || 'Error al crear');
        show('Producto creado');
        limpiarForm();
        listar();
      };
    }

    document.getElementById('btnLimpiar').onclick = () => {
      _idEditing = null;
      resetCrear();
      limpiarForm();
    };

    function limpiarForm() {
      document.getElementById('nombre').value = '';
      document.getElementById('precio').value = '';
      document.getElementById('descripcion').value = '';
      document.getElementById('imagen').value = '';
    }

    function show(texto) {
      msg.textContent = texto;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, 1600);
    }

    listar();
  </script>
</body>
</html>
